import AsyncStorage from '@react-native-async-storage/async-storage';
import * as Localization from 'expo-localization';
import { I18n } from 'i18n-js';

class LocalizationSystem {
  constructor() {
    this.supportedLanguages = {
      'en': { 
        name: 'English', 
        nativeName: 'English', 
        flag: 'üá∫üá∏', 
        rtl: false,
        script: 'latin'
      },
      'bn': { 
        name: 'Bengali', 
        nativeName: '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ', 
        flag: 'üáßüá©', 
        rtl: false,
        script: 'bengali'
      },
      'hi': { 
        name: 'Hindi', 
        nativeName: '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä', 
        flag: 'üáÆüá≥', 
        rtl: false,
        script: 'devanagari'
      },
      'ur': { 
        name: 'Urdu', 
        nativeName: 'ÿßÿ±ÿØŸà', 
        flag: 'üáµüá∞', 
        rtl: true,
        script: 'arabic'
      },
      'ar': { 
        name: 'Arabic', 
        nativeName: 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©', 
        flag: 'üá∏üá¶', 
        rtl: true,
        script: 'arabic'
      }
    };

    this.regions = {
      'BD': {
        name: 'Bangladesh',
        flag: 'üáßüá©',
        currency: 'BDT',
        dateFormat: 'DD/MM/YYYY',
        timeFormat: '12h',
        defaultLanguage: 'bn',
        curriculumBoards: ['NCTB', 'Cambridge', 'Edexcel'],
        gradeSystems: ['Class 1-12', 'O Level', 'A Level']
      },
      'IN': {
        name: 'India',
        flag: 'üáÆüá≥',
        currency: 'INR',
        dateFormat: 'DD/MM/YYYY',
        timeFormat: '12h',
        defaultLanguage: 'hi',
        curriculumBoards: ['CBSE', 'ICSE', 'State Boards'],
        gradeSystems: ['Class 1-12', 'Standard 1-12']
      },
      'PK': {
        name: 'Pakistan',
        flag: 'üáµüá∞',
        currency: 'PKR',
        dateFormat: 'DD/MM/YYYY',
        timeFormat: '12h',
        defaultLanguage: 'ur',
        curriculumBoards: ['Federal', 'Provincial', 'Cambridge'],
        gradeSystems: ['Class 1-12', 'O Level', 'A Level']
      },
      'US': {
        name: 'United States',
        flag: 'üá∫üá∏',
        currency: 'USD',
        dateFormat: 'MM/DD/YYYY',
        timeFormat: '12h',
        defaultLanguage: 'en',
        curriculumBoards: ['Common Core', 'State Standards'],
        gradeSystems: ['Grade K-12']
      }
    };

    this.currentLanguage = 'en';
    this.currentRegion = 'BD';
    this.fallbackLanguage = 'en';
    
    this.i18n = new I18n();
    this.initializeI18n();
    
    // Translation cache
    this.translationCache = new Map();
    
    // Cultural context data
    this.culturalContexts = new Map();
  }

  // ========== INITIALIZATION ==========
  async initializeI18n() {
    try {
      // Load saved preferences
      const savedLanguage = await AsyncStorage.getItem('selectedLanguage');
      const savedRegion = await AsyncStorage.getItem('selectedRegion');
      
      // Use saved preferences or detect from device
      this.currentLanguage = savedLanguage || this.detectLanguage();
      this.currentRegion = savedRegion || this.detectRegion();
      
      // Load translations
      await this.loadTranslations();
      
      // Configure i18n
      this.i18n.locale = this.currentLanguage;
      this.i18n.enableFallback = true;
      this.i18n.defaultLocale = this.fallbackLanguage;
      
    } catch (error) {
      console.error('Error initializing localization:', error);
      // Fallback to defaults
      this.currentLanguage = 'en';
      this.currentRegion = 'BD';
    }
  }

  detectLanguage() {
    const deviceLocale = Localization.locale;
    const languageCode = deviceLocale.split('-')[0];
    
    if (this.supportedLanguages[languageCode]) {
      return languageCode;
    }
    
    return this.fallbackLanguage;
  }

  detectRegion() {
    const deviceLocale = Localization.locale;
    const regionCode = deviceLocale.split('-')[1] || Localization.region;
    
    if (this.regions[regionCode]) {
      return regionCode;
    }
    
    return 'BD'; // Default to Bangladesh
  }

  // ========== TRANSLATION MANAGEMENT ==========
  async loadTranslations() {
    try {
      // Load base translations from storage or bundle
      const translations = await this.loadTranslationFiles();
      
      // Set translations in i18n
      Object.keys(translations).forEach(lang => {
        this.i18n.translations[lang] = translations[lang];
      });
      
    } catch (error) {
      console.error('Error loading translations:', error);
    }
  }

  async loadTranslationFiles() {
    // Mock translation data - in real app, these would be loaded from files or API
    return {
      en: {
        // Navigation & General
        navigation: {
          home: 'Home',
          quizzes: 'Quizzes',
          progress: 'Progress',
          competitions: 'Competitions',
          profile: 'Profile',
          settings: 'Settings'
        },
        
        // Quiz Interface
        quiz: {
          start: 'Start Quiz',
          submit: 'Submit Answer',
          next: 'Next Question',
          previous: 'Previous Question',
          finish: 'Finish Quiz',
          score: 'Score',
          time_remaining: 'Time Remaining',
          question_count: 'Question {{current}} of {{total}}',
          correct: 'Correct!',
          incorrect: 'Incorrect',
          explanation: 'Explanation',
          retry: 'Try Again'
        },
        
        // Subjects
        subjects: {
          mathematics: 'Mathematics',
          science: 'Science',
          english: 'English',
          history: 'History',
          geography: 'Geography',
          physics: 'Physics',
          chemistry: 'Chemistry',
          biology: 'Biology'
        },
        
        // Messages
        messages: {
          welcome: 'Welcome to QuizCraft!',
          loading: 'Loading...',
          error: 'An error occurred',
          success: 'Success!',
          no_internet: 'No internet connection',
          sync_complete: 'Sync completed successfully'
        },
        
        // Bangladesh specific content
        bd_content: {
          curriculum_boards: {
            nctb: 'National Curriculum and Textbook Board',
            cambridge: 'Cambridge International',
            edexcel: 'Pearson Edexcel'
          },
          grade_levels: {
            class_1: 'Class 1',
            class_2: 'Class 2',
            class_3: 'Class 3',
            class_4: 'Class 4',
            class_5: 'Class 5',
            class_6: 'Class 6',
            class_7: 'Class 7',
            class_8: 'Class 8',
            class_9: 'Class 9',
            class_10: 'Class 10',
            hsc_1: 'HSC 1st Year',
            hsc_2: 'HSC 2nd Year'
          }
        }
      },
      
      bn: {
        navigation: {
          home: '‡¶π‡ßã‡¶Æ',
          quizzes: '‡¶ï‡ßÅ‡¶á‡¶ú',
          progress: '‡¶Ö‡¶ó‡ßç‡¶∞‡¶ó‡¶§‡¶ø',
          competitions: '‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶Ø‡ßã‡¶ó‡¶ø‡¶§‡¶æ',
          profile: '‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤',
          settings: '‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏'
        },
        
        quiz: {
          start: '‡¶ï‡ßÅ‡¶á‡¶ú ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®',
          submit: '‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®',
          next: '‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®',
          previous: '‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®',
          finish: '‡¶ï‡ßÅ‡¶á‡¶ú ‡¶∂‡ßá‡¶∑ ‡¶ï‡¶∞‡ßÅ‡¶®',
          score: '‡¶∏‡ßç‡¶ï‡ßã‡¶∞',
          time_remaining: '‡¶Ö‡¶¨‡¶∂‡¶ø‡¶∑‡ßç‡¶ü ‡¶∏‡¶Æ‡¶Ø‡¶º',
          question_count: '‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® {{current}} ‡¶è‡¶∞ {{total}}',
          correct: '‡¶∏‡¶†‡¶ø‡¶ï!',
          incorrect: '‡¶≠‡ßÅ‡¶≤',
          explanation: '‡¶¨‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ',
          retry: '‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®'
        },
        
        subjects: {
          mathematics: '‡¶ó‡¶£‡¶ø‡¶§',
          science: '‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®',
          english: '‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø',
          history: '‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏',
          geography: '‡¶≠‡ßÇ‡¶ó‡ßã‡¶≤',
          physics: '‡¶™‡¶¶‡¶æ‡¶∞‡ßç‡¶•‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ',
          chemistry: '‡¶∞‡¶∏‡¶æ‡¶Ø‡¶º‡¶®',
          biology: '‡¶ú‡ßÄ‡¶¨‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®'
        },
        
        messages: {
          welcome: 'QuizCraft-‡¶è ‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ!',
          loading: '‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...',
          error: '‡¶è‡¶ï‡¶ü‡¶ø ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶ò‡¶ü‡ßá‡¶õ‡ßá',
          success: '‡¶∏‡¶´‡¶≤!',
          no_internet: '‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶®‡ßá‡¶á',
          sync_complete: '‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá'
        },
        
        bd_content: {
          curriculum_boards: {
            nctb: '‡¶ú‡¶æ‡¶§‡ßÄ‡¶Ø‡¶º ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶ï‡ßç‡¶∞‡¶Æ ‡¶ì ‡¶™‡¶æ‡¶†‡ßç‡¶Ø‡¶™‡ßÅ‡¶∏‡ßç‡¶§‡¶ï ‡¶¨‡ßã‡¶∞‡ßç‡¶°',
            cambridge: '‡¶ï‡ßá‡¶Æ‡¶¨‡ßç‡¶∞‡¶ø‡¶ú ‡¶Ü‡¶®‡ßç‡¶§‡¶∞‡ßç‡¶ú‡¶æ‡¶§‡¶ø‡¶ï',
            edexcel: '‡¶™‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞‡¶∏‡¶® ‡¶è‡¶°‡ßá‡¶ï‡ßç‡¶∏‡ßá‡¶≤'
          },
          grade_levels: {
            class_1: '‡ßß‡¶Æ ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ',
            class_2: '‡ß®‡¶Ø‡¶º ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ',
            class_3: '‡ß©‡¶Ø‡¶º ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ',
            class_4: '‡ß™‡¶∞‡ßç‡¶• ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ',
            class_5: '‡ß´‡¶Æ ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ',
            class_6: '‡ß¨‡¶∑‡ßç‡¶† ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ',
            class_7: '‡ß≠‡¶Æ ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ',
            class_8: '‡ßÆ‡¶Æ ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ',
            class_9: '‡ßØ‡¶Æ ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ',
            class_10: '‡ßß‡ß¶‡¶Æ ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ',
            hsc_1: '‡¶â‡¶ö‡ßç‡¶ö ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡¶ø‡¶ï ‡ßß‡¶Æ ‡¶¨‡¶∞‡ßç‡¶∑',
            hsc_2: '‡¶â‡¶ö‡ßç‡¶ö ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡¶ø‡¶ï ‡ß®‡¶Ø‡¶º ‡¶¨‡¶∞‡ßç‡¶∑'
          }
        }
      },
      
      hi: {
        navigation: {
          home: '‡§π‡•ã‡§Æ',
          quizzes: '‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡•ã‡§§‡•ç‡§§‡§∞‡•Ä',
          progress: '‡§™‡•ç‡§∞‡§ó‡§§‡§ø',
          competitions: '‡§™‡•ç‡§∞‡§§‡§ø‡§Ø‡•ã‡§ó‡§ø‡§§‡§æ‡§è‡§Ç',
          profile: '‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤',
          settings: '‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏'
        },
        
        quiz: {
          start: '‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡•ã‡§§‡•ç‡§§‡§∞‡•Ä ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç',
          submit: '‡§â‡§§‡•ç‡§§‡§∞ ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç',
          next: '‡§Ö‡§ó‡§≤‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®',
          previous: '‡§™‡§ø‡§õ‡§≤‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®',
          finish: '‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡•ã‡§§‡•ç‡§§‡§∞‡•Ä ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç',
          score: '‡§∏‡•ç‡§ï‡•ã‡§∞',
          time_remaining: '‡§¨‡§ö‡§æ ‡§π‡•Å‡§Ü ‡§∏‡§Æ‡§Ø',
          question_count: '‡§™‡•ç‡§∞‡§∂‡•ç‡§® {{current}} ‡§ï‡§æ {{total}}',
          correct: '‡§∏‡§π‡•Ä!',
          incorrect: '‡§ó‡§≤‡§§',
          explanation: '‡§µ‡•ç‡§Ø‡§æ‡§ñ‡•ç‡§Ø‡§æ',
          retry: '‡§´‡§ø‡§∞ ‡§∏‡•á ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç'
        },
        
        subjects: {
          mathematics: '‡§ó‡§£‡§ø‡§§',
          science: '‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§®',
          english: '‡§Ö‡§Ç‡§ó‡•ç‡§∞‡•á‡§ú‡•Ä',
          history: '‡§á‡§§‡§ø‡§π‡§æ‡§∏',
          geography: '‡§≠‡•Ç‡§ó‡•ã‡§≤',
          physics: '‡§≠‡•å‡§§‡§ø‡§ï ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§®',
          chemistry: '‡§∞‡§∏‡§æ‡§Ø‡§® ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§®',
          biology: '‡§ú‡•Ä‡§µ ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§®'
        },
        
        messages: {
          welcome: 'QuizCraft ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à!',
          loading: '‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...',
          error: '‡§è‡§ï ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à',
          success: '‡§∏‡§´‡§≤‡§§‡§æ!',
          no_internet: '‡§ï‡•ã‡§à ‡§á‡§Ç‡§ü‡§∞‡§®‡•á‡§ü ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§®‡§π‡•Ä‡§Ç',
          sync_complete: '‡§∏‡§ø‡§Ç‡§ï ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§™‡•Ç‡§∞‡§æ ‡§π‡•Å‡§Ü'
        }
      }
    };
  }

  // ========== AI-POWERED TRANSLATION ==========
  async translateText(text, targetLanguage, context = null) {
    try {
      // Check cache first
      const cacheKey = `${text}_${targetLanguage}_${context}`;
      if (this.translationCache.has(cacheKey)) {
        return this.translationCache.get(cacheKey);
      }

      // Mock AI translation service
      const translation = await this.aiTranslationService(text, targetLanguage, context);
      
      // Cache the result
      this.translationCache.set(cacheKey, translation);
      
      return translation;

    } catch (error) {
      console.error('Error translating text:', error);
      return text; // Fallback to original text
    }
  }

  async aiTranslationService(text, targetLanguage, context) {
    // Mock AI translation - in real app, this would call an AI service like Google Translate API
    const mockTranslations = {
      'bn': {
        'What is 2 + 2?': '‡ß® + ‡ß® ‡¶ï‡¶§?',
        'Choose the correct answer': '‡¶∏‡¶†‡¶ø‡¶ï ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¨‡ßá‡¶õ‡ßá ‡¶®‡¶ø‡¶®',
        'Mathematics': '‡¶ó‡¶£‡¶ø‡¶§',
        'Science': '‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®',
        'Well done!': '‡¶ñ‡ßÅ‡¶¨ ‡¶≠‡¶æ‡¶≤!',
        'Try again': '‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®'
      },
      'hi': {
        'What is 2 + 2?': '2 + 2 ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?',
        'Choose the correct answer': '‡§∏‡§π‡•Ä ‡§â‡§§‡•ç‡§§‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç',
        'Mathematics': '‡§ó‡§£‡§ø‡§§',
        'Science': '‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§®',
        'Well done!': '‡§¨‡§π‡•Å‡§§ ‡§¨‡§¢‡§º‡§ø‡§Ø‡§æ!',
        'Try again': '‡§´‡§ø‡§∞ ‡§∏‡•á ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç'
      }
    };

    // Simulate AI processing delay
    await new Promise(resolve => setTimeout(resolve, 100));

    // Return mock translation or original text
    const translation = mockTranslations[targetLanguage]?.[text] || text;
    
    return {
      originalText: text,
      translatedText: translation,
      targetLanguage,
      context,
      confidence: 0.95,
      translatedAt: new Date().toISOString()
    };
  }

  async translateQuiz(quizData, targetLanguage) {
    try {
      const translatedQuiz = { ...quizData };
      
      // Translate quiz title and description
      if (quizData.title) {
        const titleTranslation = await this.translateText(
          quizData.title, 
          targetLanguage, 
          'quiz_title'
        );
        translatedQuiz.title = titleTranslation.translatedText;
      }
      
      if (quizData.description) {
        const descTranslation = await this.translateText(
          quizData.description, 
          targetLanguage, 
          'quiz_description'
        );
        translatedQuiz.description = descTranslation.translatedText;
      }
      
      // Translate questions
      if (quizData.questions) {
        translatedQuiz.questions = await Promise.all(
          quizData.questions.map(async (question) => {
            const translatedQuestion = { ...question };
            
            // Translate question text
            if (question.question) {
              const questionTranslation = await this.translateText(
                question.question,
                targetLanguage,
                'question_text'
              );
              translatedQuestion.question = questionTranslation.translatedText;
            }
            
            // Translate options
            if (question.options) {
              translatedQuestion.options = await Promise.all(
                question.options.map(async (option) => {
                  const optionTranslation = await this.translateText(
                    option,
                    targetLanguage,
                    'answer_option'
                  );
                  return optionTranslation.translatedText;
                })
              );
            }
            
            // Translate explanation
            if (question.explanation) {
              const explanationTranslation = await this.translateText(
                question.explanation,
                targetLanguage,
                'explanation'
              );
              translatedQuestion.explanation = explanationTranslation.translatedText;
            }
            
            return translatedQuestion;
          })
        );
      }
      
      return {
        success: true,
        translatedQuiz,
        originalLanguage: quizData.language || 'en',
        targetLanguage,
        translatedAt: new Date().toISOString()
      };

    } catch (error) {
      console.error('Error translating quiz:', error);
      throw error;
    }
  }

  // ========== REGIONAL CONTENT ADAPTATION ==========
  async adaptContentForRegion(content, region) {
    try {
      const regionConfig = this.regions[region];
      if (!regionConfig) {
        throw new Error(`Unsupported region: ${region}`);
      }

      const adaptedContent = {
        ...content,
        region: region,
        currency: regionConfig.currency,
        dateFormat: regionConfig.dateFormat,
        timeFormat: regionConfig.timeFormat,
        curriculumBoards: regionConfig.curriculumBoards,
        gradeSystems: regionConfig.gradeSystems
      };

      // Apply cultural adaptations
      if (region === 'BD') {
        adaptedContent = await this.applyBangladeshAdaptations(adaptedContent);
      } else if (region === 'IN') {
        adaptedContent = await this.applyIndiaAdaptations(adaptedContent);
      } else if (region === 'PK') {
        adaptedContent = await this.applyPakistanAdaptations(adaptedContent);
      }

      return adaptedContent;

    } catch (error) {
      console.error('Error adapting content for region:', error);
      throw error;
    }
  }

  async applyBangladeshAdaptations(content) {
    const adaptations = {
      // Use Bangladeshi curriculum references
      mathTopics: [
        '‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø', '‡¶¨‡ßÄ‡¶ú‡¶ó‡¶£‡¶ø‡¶§', '‡¶ú‡ßç‡¶Ø‡¶æ‡¶Æ‡¶ø‡¶§‡¶ø', '‡¶§‡ßç‡¶∞‡¶ø‡¶ï‡ßã‡¶£‡¶Æ‡¶ø‡¶§‡¶ø', 
        '‡¶™‡¶∞‡¶ø‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶®', '‡¶∏‡¶Æ‡ßç‡¶≠‡¶æ‡¶¨‡ßç‡¶Ø‡¶§‡¶æ'
      ],
      scienceTopics: [
        '‡¶™‡¶¶‡¶æ‡¶∞‡ßç‡¶•‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶æ', '‡¶∞‡¶∏‡¶æ‡¶Ø‡¶º‡¶®', '‡¶ú‡ßÄ‡¶¨‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®', '‡¶™‡¶∞‡¶ø‡¶¨‡ßá‡¶∂‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®'
      ],
      
      // Use familiar examples and contexts
      examples: {
        currency: '‡¶ü‡¶æ‡¶ï‡¶æ',
        distances: '‡¶ï‡¶ø‡¶≤‡ßã‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞',
        temperature: '‡¶∏‡ßá‡¶≤‡¶∏‡¶ø‡¶Ø‡¶º‡¶æ‡¶∏',
        culturalReferences: [
          '‡¶¢‡¶æ‡¶ï‡¶æ', '‡¶ö‡¶ü‡ßç‡¶ü‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ', '‡¶∏‡¶ø‡¶≤‡ßá‡¶ü', '‡¶∞‡¶æ‡¶ú‡¶∂‡¶æ‡¶π‡ßÄ',
          '‡¶™‡¶¶‡ßç‡¶Æ‡¶æ ‡¶®‡¶¶‡ßÄ', '‡¶∏‡ßÅ‡¶®‡ßç‡¶¶‡¶∞‡¶¨‡¶®', '‡¶ï‡¶ï‡ßç‡¶∏‡¶¨‡¶æ‡¶ú‡¶æ‡¶∞'
        ]
      },
      
      // Educational system context
      examSystems: ['JSC', 'SSC', 'HSC'],
      boards: ['NCTB', 'Cambridge', 'Edexcel']
    };
    
    return { ...content, ...adaptations };
  }

  async applyIndiaAdaptations(content) {
    const adaptations = {
      mathTopics: [
        'Number Systems', 'Algebra', 'Geometry', 'Trigonometry',
        'Statistics', 'Probability'
      ],
      
      examples: {
        currency: 'Rupees',
        distances: 'Kilometers',
        temperature: 'Celsius',
        culturalReferences: [
          'Delhi', 'Mumbai', 'Chennai', 'Kolkata',
          'Ganges River', 'Himalayas', 'Kerala'
        ]
      },
      
      examSystems: ['CBSE', 'ICSE', 'State Board'],
      boards: ['CBSE', 'ICSE', 'Various State Boards']
    };
    
    return { ...content, ...adaptations };
  }

  async applyPakistanAdaptations(content) {
    const adaptations = {
      mathTopics: [
        'ŸÜŸÖÿ®ÿ± ÿ≥ÿ≥ŸπŸÖ', 'ÿßŸÑÿ¨ÿ®ÿ±ÿß', 'ÿ¨€åŸàŸÖ€åŸπÿ±€å', 'ŸÖÿ´ŸÑÿ´€åÿßÿ™',
        'ÿ¥ŸÖÿßÿ±€åÿßÿ™', 'ÿßŸÖ⁄©ÿßŸÜÿßÿ™'
      ],
      
      examples: {
        currency: 'Rupees',
        distances: 'Kilometers', 
        temperature: 'Celsius',
        culturalReferences: [
          '⁄©ÿ±ÿß⁄Ü€å', 'ŸÑÿß€ÅŸàÿ±', 'ÿßÿ≥ŸÑÿßŸÖ ÿ¢ÿ®ÿßÿØ', 'ŸÅ€åÿµŸÑ ÿ¢ÿ®ÿßÿØ',
          'ÿØÿ±€åÿßÿ¶€í ÿ≥ŸÜÿØ⁄æ', '⁄©€í ŸπŸà', 'ÿ≥Ÿàÿßÿ™'
        ]
      },
      
      examSystems: ['Matric', 'Intermediate', 'O Level', 'A Level'],
      boards: ['Federal Board', 'Provincial Boards', 'Cambridge']
    };
    
    return { ...content, ...adaptations };
  }

  // ========== CULTURAL CONTEXT AWARENESS ==========
  getCulturalContext(region, contentType) {
    const contextKey = `${region}_${contentType}`;
    
    if (this.culturalContexts.has(contextKey)) {
      return this.culturalContexts.get(contextKey);
    }
    
    // Generate cultural context
    const context = this.generateCulturalContext(region, contentType);
    this.culturalContexts.set(contextKey, context);
    
    return context;
  }

  generateCulturalContext(region, contentType) {
    const contexts = {
      'BD_math': {
        preferredUnits: ['metric'],
        culturalExamples: ['rice price', 'cricket scores', 'monsoon rainfall'],
        festivalsAndEvents: ['Eid', 'Pohela Boishakh', 'Victory Day'],
        commonScenarios: ['market shopping', 'bus fare calculation', 'school grades']
      },
      
      'BD_science': {
        localFlora: ['mango', 'jackfruit', 'rice', 'jute'],
        localFauna: ['Royal Bengal Tiger', 'Hilsa fish', 'peacock'],
        environmental: ['monsoon', 'cyclones', 'rivers', 'deltas'],
        technology: ['mobile banking', 'solar panels', 'tube wells']
      },
      
      'IN_math': {
        preferredUnits: ['metric', 'traditional units like maund'],
        culturalExamples: ['cricket statistics', 'Bollywood box office'],
        festivalsAndEvents: ['Diwali', 'Holi', 'Independence Day'],
        commonScenarios: ['train schedules', 'market prices', 'exam scores']
      },
      
      'PK_math': {
        preferredUnits: ['metric'],
        culturalExamples: ['cricket scores', 'currency exchange'],
        festivalsAndEvents: ['Eid', 'Pakistan Day', 'Independence Day'],
        commonScenarios: ['bazaar shopping', 'exam results', 'sports scores']
      }
    };
    
    const contextKey = `${region}_${contentType}`;
    return contexts[contextKey] || {};
  }

  // ========== SCRIPT SUPPORT ==========
  getScriptDirection(language) {
    const langConfig = this.supportedLanguages[language];
    return langConfig ? (langConfig.rtl ? 'rtl' : 'ltr') : 'ltr';
  }

  getScriptType(language) {
    const langConfig = this.supportedLanguages[language];
    return langConfig ? langConfig.script : 'latin';
  }

  formatTextForScript(text, language) {
    const scriptType = this.getScriptType(language);
    const direction = this.getScriptDirection(language);
    
    return {
      text,
      direction,
      script: scriptType,
      fontFamily: this.getFontFamily(scriptType),
      needsSpecialHandling: scriptType !== 'latin'
    };
  }

  getFontFamily(scriptType) {
    const fonts = {
      'latin': 'System',
      'bengali': 'SolaimanLipi', // For Bengali text
      'devanagari': 'Mangal', // For Hindi text
      'arabic': 'Al Nile' // For Arabic/Urdu text
    };
    
    return fonts[scriptType] || 'System';
  }

  // ========== LANGUAGE MANAGEMENT ==========
  async setLanguage(languageCode) {
    try {
      if (!this.supportedLanguages[languageCode]) {
        throw new Error(`Unsupported language: ${languageCode}`);
      }

      this.currentLanguage = languageCode;
      this.i18n.locale = languageCode;
      
      // Save preference
      await AsyncStorage.setItem('selectedLanguage', languageCode);
      
      return {
        success: true,
        language: languageCode,
        message: 'Language changed successfully'
      };

    } catch (error) {
      console.error('Error setting language:', error);
      throw error;
    }
  }

  async setRegion(regionCode) {
    try {
      if (!this.regions[regionCode]) {
        throw new Error(`Unsupported region: ${regionCode}`);
      }

      this.currentRegion = regionCode;
      
      // Save preference
      await AsyncStorage.setItem('selectedRegion', regionCode);
      
      // Optionally change language to region's default
      const regionConfig = this.regions[regionCode];
      if (regionConfig.defaultLanguage !== this.currentLanguage) {
        await this.setLanguage(regionConfig.defaultLanguage);
      }
      
      return {
        success: true,
        region: regionCode,
        message: 'Region changed successfully'
      };

    } catch (error) {
      console.error('Error setting region:', error);
      throw error;
    }
  }

  // ========== FORMATTING UTILITIES ==========
  formatNumber(number, language = this.currentLanguage) {
    try {
      const locale = this.getLocaleString(language);
      return new Intl.NumberFormat(locale).format(number);
    } catch (error) {
      return number.toString();
    }
  }

  formatCurrency(amount, currency = null, language = this.currentLanguage) {
    try {
      const locale = this.getLocaleString(language);
      const currencyCode = currency || this.regions[this.currentRegion]?.currency || 'USD';
      
      return new Intl.NumberFormat(locale, {
        style: 'currency',
        currency: currencyCode
      }).format(amount);
    } catch (error) {
      return `${amount} ${currency}`;
    }
  }

  formatDate(date, language = this.currentLanguage) {
    try {
      const locale = this.getLocaleString(language);
      const dateFormat = this.regions[this.currentRegion]?.dateFormat || 'DD/MM/YYYY';
      
      return new Intl.DateTimeFormat(locale).format(new Date(date));
    } catch (error) {
      return new Date(date).toLocaleDateString();
    }
  }

  formatTime(time, language = this.currentLanguage) {
    try {
      const locale = this.getLocaleString(language);
      const timeFormat = this.regions[this.currentRegion]?.timeFormat || '12h';
      
      return new Intl.DateTimeFormat(locale, {
        hour: 'numeric',
        minute: 'numeric',
        hour12: timeFormat === '12h'
      }).format(new Date(time));
    } catch (error) {
      return new Date(time).toLocaleTimeString();
    }
  }

  getLocaleString(language) {
    const localeMap = {
      'en': 'en-US',
      'bn': 'bn-BD',
      'hi': 'hi-IN',
      'ur': 'ur-PK',
      'ar': 'ar-SA'
    };
    
    return localeMap[language] || 'en-US';
  }

  // ========== TRANSLATION INTERFACE ==========
  t(key, interpolation = {}) {
    return this.i18n.t(key, interpolation);
  }

  // Get current language info
  getCurrentLanguage() {
    return {
      code: this.currentLanguage,
      ...this.supportedLanguages[this.currentLanguage]
    };
  }

  // Get current region info
  getCurrentRegion() {
    return {
      code: this.currentRegion,
      ...this.regions[this.currentRegion]
    };
  }

  // Get all supported languages
  getSupportedLanguages() {
    return Object.entries(this.supportedLanguages).map(([code, info]) => ({
      code,
      ...info
    }));
  }

  // Get all supported regions
  getSupportedRegions() {
    return Object.entries(this.regions).map(([code, info]) => ({
      code,
      ...info
    }));
  }

  // ========== CONTENT LOCALIZATION PIPELINE ==========
  async localizeContent(content, targetLanguage = this.currentLanguage, targetRegion = this.currentRegion) {
    try {
      let localizedContent = { ...content };
      
      // Step 1: Translate text content
      if (targetLanguage !== 'en') {
        localizedContent = await this.translateQuiz(localizedContent, targetLanguage);
        localizedContent = localizedContent.translatedQuiz;
      }
      
      // Step 2: Adapt for regional context
      localizedContent = await this.adaptContentForRegion(localizedContent, targetRegion);
      
      // Step 3: Apply cultural context
      const culturalContext = this.getCulturalContext(targetRegion, content.type || 'general');
      localizedContent.culturalContext = culturalContext;
      
      // Step 4: Format for script requirements
      const scriptInfo = this.formatTextForScript('', targetLanguage);
      localizedContent.scriptInfo = scriptInfo;
      
      return {
        success: true,
        localizedContent,
        sourceLanguage: content.language || 'en',
        targetLanguage,
        targetRegion,
        localizedAt: new Date().toISOString()
      };

    } catch (error) {
      console.error('Error localizing content:', error);
      throw error;
    }
  }
}

export const localizationSystem = new LocalizationSystem();
export default localizationSystem;